<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>services/api.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#API_BASE">API_BASE</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#AUTH_TOKEN_EVENT">AUTH_TOKEN_EVENT</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AboutPage">AboutPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AccountPage">AccountPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AppFooter">AppFooter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AppHeader">AppHeader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Breadcrumbs">Breadcrumbs</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#CHAT_URL">CHAT_URL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#CreateMeetingPage">CreateMeetingPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ForgotPasswordPage">ForgotPasswordPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#HomePage">HomePage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NotFoundPage">NotFoundPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PasswordStrengthHint">PasswordStrengthHint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#RegisterPage">RegisterPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ResetPasswordPage">ResetPasswordPage</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#STORAGE_KEY">STORAGE_KEY</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SitemapPage">SitemapPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ToastProvider">ToastProvider</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#TopLoadingBar">TopLoadingBar</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#VOICE_URL">VOICE_URL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#apiFetch">apiFetch</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#auth">auth</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#changePassword">changePassword</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#cleanupAllPeers">cleanupAllPeers</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#closePeer">closePeer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#connectSocket">connectSocket</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#connectVoiceSocket">connectVoiceSocket</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#createAndSendOffer">createAndSendOffer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#createMeeting">createMeeting</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteMeetingApi">deleteMeetingApi</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteProfile">deleteProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#disconnectSocket">disconnectSocket</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#disconnectVoiceSocket">disconnectVoiceSocket</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ensurePeerConnection">ensurePeerConnection</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#firebaseConfig">firebaseConfig</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getAuthToken">getAuthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getIceServers">getIceServers</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getMeeting">getMeeting</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getProfile">getProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#handleIncomingAnswer">handleIncomingAnswer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#handleIncomingCandidate">handleIncomingCandidate</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#handleIncomingOffer">handleIncomingOffer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#joinRoom">joinRoom</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#joinVoiceRoom">joinVoiceRoom</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#listMeetings">listMeetings</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#loginWithEmailPassword">loginWithEmailPassword</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#navLinkClass">navLinkClass</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onChatMessage">onChatMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onExistingUsers">onExistingUsers</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onRoomFull">onRoomFull</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onSocketConnect">onSocketConnect</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onSocketDisconnect">onSocketDisconnect</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onSocketError">onSocketError</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onUserJoined">onUserJoined</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onUserLeft">onUserLeft</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceConnect">onVoiceConnect</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceDisconnect">onVoiceDisconnect</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceError">onVoiceError</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceExistingUsers">onVoiceExistingUsers</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoicePeerMediaToggle">onVoicePeerMediaToggle</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceRoomFull">onVoiceRoomFull</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceUserJoined">onVoiceUserJoined</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceUserLeft">onVoiceUserLeft</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceWebrtcAnswer">onVoiceWebrtcAnswer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceWebrtcCandidate">onVoiceWebrtcCandidate</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onVoiceWebrtcOffer">onVoiceWebrtcOffer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#registerUser">registerUser</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#requestPasswordReset">requestPasswordReset</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#sendChatMessage">sendChatMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#sendVoiceIceCandidate">sendVoiceIceCandidate</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#sendVoiceMediaToggle">sendVoiceMediaToggle</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#sendWebrtcAnswer">sendWebrtcAnswer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#sendWebrtcOffer">sendWebrtcOffer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#setAuthToken">setAuthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#subscribe">subscribe</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#updateEmail">updateEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#updateMeeting">updateMeeting</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#updateProfile">updateProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#useToast">useToast</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">services/api.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { getAuthToken } from "./authToken";
/**
 * Base URL for backend requests. Falls back to sensible defaults per environment.
 */
const API_BASE = import.meta.env.VITE_API_BASE_URL ||
    (import.meta.env.DEV
        ? import.meta.env.VITE_API_BASE_URL_LOCAL || "http://localhost:8080/api/v1"
        : import.meta.env.VITE_API_BASE_URL_PROD ||
            "https://backend-meet-lloz.onrender.com/api/v1");
/**
 * Perform a JSON HTTP request against the backend.
 *
 * - Automatically appends the bearer token from localStorage (or override).
 * - Serializes the body as JSON and parses JSON responses when present.
 * - Throws an Error with a normalized message when the response is not ok.
 *
 * @template TResponse Expected JSON response shape.
 * @template TBody Outgoing request body shape.
 * @param {string} path API path starting with `/`.
 * @param {ApiOptions&lt;TBody>} [options] HTTP method, body, or token override.
 * @returns {Promise&lt;TResponse>} Parsed JSON response or `undefined` for 204/no-json.
 * @throws {Error} When the response is not ok or JSON parsing fails.
 */
async function apiFetch(path, options = {}) {
    const { method = "GET", body, tokenOverride } = options;
    const headers = {
        "Content-Type": "application/json",
    };
    const token = tokenOverride ?? getAuthToken();
    if (token) {
        headers.Authorization = `Bearer ${token}`;
    }
    const response = await fetch(`${API_BASE}${path}`, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined,
    });
    const isJson = response.headers.get("content-type")?.includes("application/json") ?? false;
    if (!response.ok) {
        const errorPayload = isJson ? await response.json().catch(() => null) : null;
        const message = errorPayload?.message ||
            errorPayload?.error ||
            `Request failed with status ${response.status}`;
        throw new Error(message);
    }
    if (response.status === 204 || !isJson) {
        return undefined;
    }
    return (await response.json());
}
/**
 * Create a new user account.
 *
 * @param {RegisterPayload} payload User profile and credentials.
 * @returns {Promise&lt;{ message: string } &amp; Record&lt;string, unknown>>} Success message plus any extra backend fields.
 */
export const registerUser = (payload) => apiFetch("/users/register", {
    method: "POST",
    body: payload,
});
/**
 * Trigger a password reset email flow.
 *
 * @param {string} email User email to send the reset link to.
 * @returns {Promise&lt;{ message: string; resetLink?: string }>} Backend message, optionally including the reset link in non-production envs.
 */
export const requestPasswordReset = (email) => apiFetch("/users/request-password-reset", {
    method: "POST",
    body: { email },
});
/**
 * Authenticate a user with email and password.
 *
 * @param {string} email Email address.
 * @param {string} password Plain text password.
 * @returns {Promise&lt;LoginResponse>} Backend response with tokens and optional user profile.
 */
export const loginWithEmailPassword = (email, password) => apiFetch("/users/login", {
    method: "POST",
    body: { email, password },
});
/**
 * Fetch the authenticated user's profile.
 *
 * @returns {Promise&lt;UserProfile>} Profile attributes from the backend.
 */
export const getProfile = () => apiFetch("/users/profile");
/**
 * Update profile attributes for the current user.
 *
 * @param {Partial&lt;UserProfile>} data Fields to update.
 * @returns {Promise&lt;{ message: string }>} Confirmation message.
 */
export const updateProfile = (data) => apiFetch("/users/profile", {
    method: "PUT",
    body: data,
});
/**
 * Change the email of the authenticated user.
 *
 * @param {string} email New email address.
 * @returns {Promise&lt;{ message: string }>} Confirmation message.
 */
export const updateEmail = (email) => apiFetch("/users/email", {
    method: "PUT",
    body: { email },
});
/**
 * Re-authenticate the user via Firebase REST API and update their password.
 *
 * Note: Uses direct Firebase endpoints because the backend does not yet expose this flow.
 *
 * @param {string} email Current email used for sign-in.
 * @param {string} currentPassword Current password (for re-authentication).
 * @param {string} newPassword New password to set.
 * @returns {Promise&lt;{ message: string }>} Confirmation message when successful.
 */
export const changePassword = async (email, currentPassword, newPassword) => {
    const apiKey = import.meta.env.VITE_FIREBASE_API_KEY;
    if (!apiKey) {
        throw new Error("Falta VITE_FIREBASE_API_KEY para cambiar contraseña");
    }
    // Reautenticación: obtener idToken
    const loginResp = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            email,
            password: currentPassword,
            returnSecureToken: true,
        }),
    });
    const loginData = await loginResp.json().catch(() => null);
    if (!loginResp.ok || !loginData?.idToken) {
        const msg = loginData?.error?.message === "INVALID_PASSWORD"
            ? "Contraseña actual incorrecta"
            : loginData?.error?.message || "No se pudo reautenticar";
        throw new Error(msg);
    }
    // Actualización de contraseña
    const updateResp = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            idToken: loginData.idToken,
            password: newPassword,
            returnSecureToken: true,
        }),
    });
    const updateData = await updateResp.json().catch(() => null);
    if (!updateResp.ok) {
        const msg = updateData?.error?.message || "No se pudo cambiar la contraseña";
        throw new Error(msg);
    }
    return { message: "Contraseña actualizada" };
};
/**
 * Delete the authenticated user's account.
 *
 * @returns {Promise&lt;{ message: string }>} Confirmation message from the backend.
 */
export const deleteProfile = () => apiFetch("/users/profile", { method: "DELETE" });
/**
 * Create a new meeting for the authenticated user.
 *
 * @param {CreateMeetingPayload} payload Meeting metadata to persist.
 * @returns {Promise&lt;{ message: string; meeting: Meeting }>} Confirmation plus created meeting.
 */
export const createMeeting = (payload) => apiFetch("/meetings", {
    method: "POST",
    body: payload,
});
/**
 * List meetings owned by the authenticated user.
 *
 * @returns {Promise&lt;Meeting[]>} Collection of meetings.
 */
export const listMeetings = () => apiFetch("/meetings");
/**
 * Get a single meeting by ID.
 *
 * @param {string} id Meeting identifier.
 * @returns {Promise&lt;Meeting>} Meeting details.
 */
export const getMeeting = (id) => apiFetch(`/meetings/${id}`);
/**
 * Update meeting metadata.
 *
 * @param {string} id Meeting identifier.
 * @param {Partial&lt;Meeting>} data Fields to patch.
 * @returns {Promise&lt;{ message: string }>} Confirmation message.
 */
export const updateMeeting = (id, data) => apiFetch(`/meetings/${id}`, {
    method: "PUT",
    body: data,
});
/**
 * Delete a meeting by ID.
 *
 * @param {string} id Meeting identifier.
 * @returns {Promise&lt;{ message: string }>} Confirmation message.
 */
export const deleteMeetingApi = (id) => apiFetch(`/meetings/${id}`, { method: "DELETE" });
export { API_BASE };
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Fri Nov 28 2025 21:45:53 GMT-0500 (hora estándar de Colombia) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
